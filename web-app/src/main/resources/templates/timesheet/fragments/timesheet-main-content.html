<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<!-- Main Timesheet Content Fragment -->
<div th:fragment="timesheet-main-content">
    <!-- Date Range Display -->
    <div class="r-date-range" id="r-date-range" th:text="|${weeklyTimesheet.weekStart} – ${weeklyTimesheet.weekEnd}|">
        2025-07-21 – 2025-07-27
    </div>

    <!-- Main Timesheet Form -->
    <form id="r-timesheet-form" th:object="${saveTimesheetRequest}">

        <!-- Hidden field for week start -->
        <input type="hidden" name="weekStart" th:value="${saveTimesheetRequest.weekStart}" th:unless="${weeklyTimesheet.rows.isEmpty()}">

        <!-- Error Message Container for Add Row Operations -->
        <div id="r-add-row-error-container" class="r-error-container"></div>

        <!-- Timesheet Table -->
        <div class="r-timesheet-wrapper">
            <table class="r-timesheet-table" id="r-timesheet-table">
                <thead>
                <tr>
                    <th class="r-project-header">Project</th>
                    <th class="r-activity-header">Activity</th>
                    <th th:each="date, dateStat : ${weekDates}" class="r-day-header">
                        <div class="r-day-date" th:text="${date.dayOfMonth}">21</div>
                        <div class="r-day-name" th:text="${dayNames[dateStat.index]}">Mon</div>
                    </th>
                    <th class="r-total-header">Total</th>
                    <th class="r-remain-header">Remain.</th>
                </tr>
                </thead>
                <tbody id="r-timesheet-rows">
                <!-- Dynamic rows from backend -->
                <tr th:each="row, rowStat : ${weeklyTimesheet.rows}" class="r-timesheet-row"
                    th:data-row-id="${row.rowId}"
                    th:data-has-saved-entries="${row.hasSavedEntries}"
                    th:attr="data-entry-ids=${row.entryIds != null ? row.entryIds.toString() : '{}'}">

                    <!-- Hidden fields for row data -->
                    <input type="hidden" th:name="|rows[${rowStat.index}].rowId|" th:value="${row.rowId}"/>

                    <td class="r-project-cell">
                        <wa-select size="small" th:name="|rows[${rowStat.index}].projectId|" th:value="${row.projectId}" class="r-project-select"
                                   th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}">
                            <wa-option value="" th:selected="${row.projectId == null or row.projectId == ''}">Select Project</wa-option>
                            <wa-option th:each="project : ${projects}" th:value="${project.id}"
                                       th:text="${project.name}" th:selected="${project.id == row.projectId}"></wa-option>
                        </wa-select>
                    </td>
                    <td class="r-activity-cell">
                        <wa-select size="small" th:name="|rows[${rowStat.index}].activityId|" th:value="${row.activityId}" class="r-activity-select"
                                   th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}">
                            <wa-option value="" th:selected="${row.activityId == null or row.activityId == ''}">Select Activity</wa-option>
                            <wa-option th:each="activity : ${activities}" th:value="${activity.id}"
                                       th:text="${activity.name}" th:selected="${activity.id == row.activityId}"></wa-option>
                        </wa-select>
                    </td>
                    <td class="r-day-cell">
                        <wa-input type="number" size="small" min="0" max="24" step="0.25"
                                  th:name="|rows[${rowStat.index}].hours[mon]|" th:value="${row.hours['mon']}"
                                  class="r-hours-input" data-day="mon" th:data-row="${row.rowId}"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                        <wa-input size="small" placeholder="Comment"
                                  th:name="|rows[${rowStat.index}].comments[mon]|" th:value="${row.comments['mon']}"
                                  class="r-comment-input"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                    </td>
                    <td class="r-day-cell">
                        <wa-input type="number" size="small" min="0" max="24" step="0.25"
                                  th:name="|rows[${rowStat.index}].hours[tue]|" th:value="${row.hours['tue']}"
                                  class="r-hours-input" data-day="tue" th:data-row="${row.rowId}"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                        <wa-input size="small" placeholder="Comment"
                                  th:name="|rows[${rowStat.index}].comments[tue]|" th:value="${row.comments['tue']}"
                                  class="r-comment-input"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                    </td>
                    <td class="r-day-cell">
                        <wa-input type="number" size="small" min="0" max="24" step="0.25"
                                  th:name="|rows[${rowStat.index}].hours[wed]|" th:value="${row.hours['wed']}"
                                  class="r-hours-input" data-day="wed" th:data-row="${row.rowId}"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                        <wa-input size="small" placeholder="Comment"
                                  th:name="|rows[${rowStat.index}].comments[wed]|" th:value="${row.comments['wed']}"
                                  class="r-comment-input"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                    </td>
                    <td class="r-day-cell">
                        <wa-input type="number" size="small" min="0" max="24" step="0.25"
                                  th:name="|rows[${rowStat.index}].hours[thu]|" th:value="${row.hours['thu']}"
                                  class="r-hours-input" data-day="thu" th:data-row="${row.rowId}"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                        <wa-input size="small" placeholder="Comment"
                                  th:name="|rows[${rowStat.index}].comments[thu]|" th:value="${row.comments['thu']}"
                                  class="r-comment-input"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                    </td>
                    <td class="r-day-cell">
                        <wa-input type="number" size="small" min="0" max="24" step="0.25"
                                  th:name="|rows[${rowStat.index}].hours[fri]|" th:value="${row.hours['fri']}"
                                  class="r-hours-input" data-day="fri" th:data-row="${row.rowId}"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                        <wa-input size="small" placeholder="Comment"
                                  th:name="|rows[${rowStat.index}].comments[fri]|" th:value="${row.comments['fri']}"
                                  class="r-comment-input"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                    </td>
                    <td class="r-day-cell">
                        <wa-input type="number" size="small" min="0" max="24" step="0.25"
                                  th:name="|rows[${rowStat.index}].hours[sat]|" th:value="${row.hours['sat']}"
                                  class="r-hours-input" data-day="sat" th:data-row="${row.rowId}"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                        <wa-input size="small" placeholder="Comment"
                                  th:name="|rows[${rowStat.index}].comments[sat]|" th:value="${row.comments['sat']}"
                                  class="r-comment-input"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                    </td>
                    <td class="r-day-cell">
                        <wa-input type="number" size="small" min="0" max="24" step="0.25"
                                  th:name="|rows[${rowStat.index}].hours[sun]|" th:value="${row.hours['sun']}"
                                  class="r-hours-input" data-day="sun" th:data-row="${row.rowId}"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                        <wa-input size="small" placeholder="Comment"
                                  th:name="|rows[${rowStat.index}].comments[sun]|" th:value="${row.comments['sun']}"
                                  class="r-comment-input"
                                  th:disabled="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></wa-input>
                    </td>
                    <td class="r-total-cell">
                            <span class="r-row-total" th:data-row="${row.rowId}"
                                  th:text="${row.totalHours}">0.0</span>
                    </td>
                    <td class="r-remain-cell">
                        <form></form>
                        <!-- For rows with saved entries, use HTMX POST for delete -->
                        <form th:if="${weeklyTimesheet.approvalStatus != 'APPROVED' and row.hasSavedEntries}"
                              hx-post="/htmx/timesheet/entries/delete"
                              hx-target="#timesheet-main-container"
                              hx-swap="innerHTML"
                              hx-confirm="Are you sure you want to delete this row?">

                            <!-- Hidden fields for delete request model -->
                            <input type="hidden" name="weekStart" th:value="${saveTimesheetRequest.weekStart}"/>
                            <th:block th:each="entryId, entryIdStat : ${row.entryIds.values()}">
                                <input type="hidden" th:name="|entryIds[${entryIdStat.index}]|" th:value="${entryId}" th:if="${entryId != null}"/>
                            </th:block>

                            <wa-button size="small" variant="danger" appearance="outlined" type="submit">
                                <wa-icon name="x"></wa-icon>
                            </wa-button>
                        </form>

                        <!-- For rows without saved entries, use JavaScript (local removal only) -->
                        <wa-button size="small" variant="danger" appearance="outlined"
                                   th:onclick="|removeRow(${row.rowId})|" type="button"
                                   th:unless="${weeklyTimesheet.approvalStatus == 'APPROVED' or row.hasSavedEntries}">
                            <wa-icon name="x"></wa-icon>
                        </wa-button>
                        <!-- Show empty cell for approved timesheets -->
                        <span th:if="${weeklyTimesheet.approvalStatus == 'APPROVED'}"></span>
                    </td>
                </tr>
                </tbody>
                <tfoot>
                <tr class="r-new-row" th:unless="${weeklyTimesheet.approvalStatus == 'APPROVED'}">
                    <td colspan="11">
                        <form style="display: inline;">
                            <input type="hidden" name="weekStart" th:value="${saveTimesheetRequest.weekStart}"/>
                            <wa-button size="small" variant="neutral" appearance="outlined" 
                                hx-post="/htmx/timesheet/add-row"
                                hx-include="closest form"
                                hx-target="#r-timesheet-rows"
                                hx-swap="beforeend"
                                hx-on::before-request="document.getElementById('r-add-row-error-container').innerHTML = ''"
                                hx-on::response-error="
                                    let errorContainer = document.getElementById('r-add-row-error-container');
                                    errorContainer.innerHTML = event.detail.xhr.responseText;
                                "
                                type="button" class="r-new-row-btn">
                                New row
                            </wa-button>
                        </form>
                    </td>
                </tr>
                <tr class="r-totals-row">
                    <td colspan="2" class="r-totals-label">Total</td>
                    <td class="r-day-total" id="r-total-mon" th:text="${weeklyTimesheet.dayTotals['mon']}">0.0</td>
                    <td class="r-day-total" id="r-total-tue" th:text="${weeklyTimesheet.dayTotals['tue']}">0.0</td>
                    <td class="r-day-total" id="r-total-wed" th:text="${weeklyTimesheet.dayTotals['wed']}">0.0</td>
                    <td class="r-day-total" id="r-total-thu" th:text="${weeklyTimesheet.dayTotals['thu']}">0.0</td>
                    <td class="r-day-total" id="r-total-fri" th:text="${weeklyTimesheet.dayTotals['fri']}">0.0</td>
                    <td class="r-day-total" id="r-total-sat" th:text="${weeklyTimesheet.dayTotals['sat']}">0.0</td>
                    <td class="r-day-total" id="r-total-sun" th:text="${weeklyTimesheet.dayTotals['sun']}">0.0</td>
                    <td class="r-grand-total" id="r-grand-total" th:text="${weeklyTimesheet.grandTotal}">0.0</td>
                    <td></td>
                </tr>
                </tfoot>
            </table>
        </div>

    </form>

    <!-- Completion Status -->
    <div class="r-completion-section" th:unless="${weeklyTimesheet.approvalStatus == 'APPROVED'}">
        <th:block th:replace="~{timesheet/fragments/timesheet-submit :: submit-section}"></th:block>
    </div>

    <!-- Time Report Section -->
    <div class="r-time-report">
        <h3 class="r-time-report-title">Time report</h3>
        <div class="r-time-report-wrapper">
            <table class="r-time-report-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Project / Activity</th>
                        <th>Hours</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody id="r-time-report-rows">
                    <!-- Server-rendered time report entries -->
                    <tr th:each="entry : ${timeReportEntries}">
                        <td th:text="${entry.date}">2025-07-21</td>
                        <td th:text="${entry.projectName + (entry.activityName != null ? ' / ' + entry.activityName : '')}">General / Development</td>
                        <td th:text="${entry.hours}">2.0</td>
                        <td th:text="${entry.notes ?: '-'}">-</td>
                    </tr>
                    <!-- Show empty message only if no entries -->
                    <tr th:if="${timeReportEntries == null or timeReportEntries.empty}">
                        <td colspan="4" style="text-align: center; color: var(--wa-color-gray-50); font-style: italic;">
                            No time entries for this week
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

</html>
